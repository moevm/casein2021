{% extends 'base.html' %}

{% block title %}Курс {{course.name}}{% endblock %}

{% block content %}

<div class="bg-holder d-none d-sm-block"
    style="background-image:url(static/img/hero-bg.png);background-position:right top;background-size:contain;">
</div>
<!--/.bg-holder-->

<div class="bg-holder d-sm-none"
    style="background-image:url(static/img/hero-bg.png);background-position:right top;background-size:contain;">
</div>


<div class="container">
    <div class="row justify-content-center align-items-center min-vh-75 min-vh-md-100">
        <div class="col-md-12 col-lg-6 py-6 text-sm-start text-center">
            <h3 class="mt-6 mb-sm-4 display-2 fw-semi-bold lh-sm fs-4 fs-lg-6 fs-xxl-8">{{course.name}}</h3>
            <p class="mb-4 fs-1">{{course.description}}</p>
            {% if current_user.has_role('admin') %}
            <div class="mt-5 mb-5 mx-auto" style="width: 150px">
                <a href="/course/update/{{ course._id }}" class="btn btn-secondary bg-gradient order-0">Редактировать</a>
            </div>
            {% endif %}
            <p>Список задач</p>
            <form id="course_tasks">
                <hr>
                {% for task in course.tasks %}
                    <div>
                        <p>{{task.name}}</p>
                        <p>{{task.condition}}</p> 
                        {% if task.task_type == 'test' %}
                            {% set test_type = (task and task.check['test']['test_type']) or 'radio' %}
                            <div id="{{task._id}}">
                                <ul id="{{task._id}}" class="list-group">
                                    {% for (answer, text) in task.check['test']['answers'] %}
                                        <li style="list-style-type: none;"><input name="{{task._id}}" type="{{test_type}}" {% if test_type == 'radio' %}required{% endif %}><span>    {{text}}</span></li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                    </div>
                    <hr>
                {% endfor %}
                <button id="check_test" type="submit" class="btn btn-primary">Проверить</button>
                <div id='check_result'></div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}
<script>
    $(function() {
        var tasks = [{% for task in course.tasks %}"{{task._id}}", {% endfor %}]
        
        $('#course_tasks').on('submit', function(event){
            $("#check_test").html("<span class='spinner-border spinner-border-sm'></span> Проверка")
            event.preventDefault()
            var answers = []
            for (i in tasks){
                var task_id = tasks[i]
                var task_answers = []
                $(`#${task_id} li`).each(function() {
                    var [radio_btn, ans_text] = $(this).children()
                    task_answers.push(radio_btn.checked)
                })
                answers.push([task_id, task_answers])
            }
            console.log(JSON.stringify(answers))
            $.ajax({
				url: "{{url_for('course.course_check', course_id=course._id)}}",
				type:'POST',
                dataType: 'JSON',
				contenType: 'application/json',
				data: {
                    'answers': JSON.stringify(answers)
                },
				success: function(resp){
                    $("#check_test").html("Проверено")
                    $("#check_result").html(`<pre>${resp['result']}</pre>`)
                    console.log(resp)
				},
				error: function(resp){
                    console.log(resp.responseText)
                    $("#check_test").html("Что-то пошло не так! Попробуйте позже")
				},
			});
        })
    })
        
</script>
{% endblock %}